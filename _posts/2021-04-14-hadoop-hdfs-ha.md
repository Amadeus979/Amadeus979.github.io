---
layout:     post
title:      Hadoop
subtitle:   hadoop-hdfs-ha
date:       2020-04-14
author:     BY, Amadeus979
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - Blog

---

# hadoop-hdfs-ha

主从集群：结构相对简单，主与从协作

主：单点，数据一致好掌握

### 问题：

- 单点故障（网断了，内存溢出等），集群整体不可用
  - 凡是主从集群都有这个问题，读写流程第一步都要去访问namenode获取元数据，没有namenode他就不知道数据应该上传到哪儿或从哪里读取
- 压力过大，内存受限
  - 内存大小限制了元数据，间接限制了集群创建元数据和上传数据，datanode空间很大，但是namenode可能只能上传一点点。
  - 如五千台的集群，namenode可能只有一台，namenode的数据连接和请求到达可能很多，单点服务器的性能就会成为瓶颈。

### 方案

单点故障：

- 高可用方案：HA（High Available）
- 多个NN，**主备**切换（只有主namenode在工作，备份namenode只有主的挂了才顶上去工作）

压力过大，内存受限：

- 联帮机制： Federation（元数据分片）
- 多个NN，管理不同的元数据

HADOOP 2.x 只支持HA的一主一备，3.x支持一主五备，但是官方推荐只用三个（考虑网络通信等问题）

## HDFS-HA解决方案：

![](https://raw.githubusercontent.com/Amadeus979/CloudImage/main/img/20210412205528.png)

某一时刻客户端只能和一个NN通信。

Namenode元数据有两类：

1. client交互操作mkdir /a

2. DN提交的block

DN一直向两个NN同时汇报，因此同步考虑的就是Client，切换NN后要保证有相同的和Client的交互。也即HA的数据同步主要考虑的就是client的操作。

方案一：同步阻塞通信机制，两者保证强一致性，强一致性破坏了对外服务的可用性。

### CAP原则：

- Consistency：一致性
- Availability：可用性
- Partition  tolerance：分区容忍性

![](https://raw.githubusercontent.com/Amadeus979/CloudImage/main/img/image-20201202151907853.png)

三个不可能在一个集群中同时被满足——全交集不可能实现。

CA：RDBMS，关系型数据库，单机的，加上事务、日志、可靠、持久化就能达到CA。但是此时如果加上主备（分区容忍性），同步时就一定有延迟和数据不一致，很难实现。

CP：有A,B两个数据，分别放在两台机器，没有任何一台拿到全量数据，每一台相当于单机，强一致性可以保证，分区容忍也可以保证，但是如果有一台挂掉，对外表现是有一部分数据取不到，可用性受到破坏。

方案二：异步非阻塞模型。Client说要创建a目录，NN创建之后也发给另一台，不等待另一台的返回，立刻给客户端响应。

折中：弱一致性/最终一致性：两个NN之间加一个组件。找到一个相对可靠的技术，发过去一定会写成功，某个时间点最终另一个NN从中间的组件读取再写过去。中间的东西必须可靠且可用。

单点不可靠，使用JN集群，但是又出现了之前的多点问题。

解决：三个JN过半返回OK，认为写成功，NN给客户端返回成功。最新版本一定在JN中数量最多。

### Paxos 算法

Paxos算法是莱斯利·兰伯特于1990年提出的一种基于**消息传递**的一致性算法。

这个算法被认为是类似算法中最有效的。

该算法覆盖全部场景的一致性。

每种技术会根据自己技术的特征选择简化算法实现。

传递：NN之间通过一个可靠的传输技术，最终数据能同步就可以

- 我们一般假设网络等因素是稳定的
- 类似一种带存储能力的消息队列

简化思路：

分布式节点是否明确

节点权重是否明确（投票争抢变为谦让）

强一致性破坏可用性

过半通过可以中和一致性和可用性

最简单的自我协调实现：主从

主的选举：明确节点数量和权重

主从的职能：

- 主：增删改查
- 从：查询，增删改传递给主
- 主与从：过半数同步数据

![](https://raw.githubusercontent.com/Amadeus979/CloudImage/main/img/image-20201202155449500.png)